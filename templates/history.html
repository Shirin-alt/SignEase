{% extends "layout.html" %}

{% block title %}Detection History{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Detection History</h2>
    </div>
</div>

<!-- Tabs Navigation -->
<ul class="nav nav-tabs mb-4" id="historyTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="sign-tab" data-bs-toggle="tab" data-bs-target="#sign-history" type="button" role="tab" aria-controls="sign-history" aria-selected="true">
            <i class="fas fa-hand-paper"></i> Sign Language Detections
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="speech-tab" data-bs-toggle="tab" data-bs-target="#speech-history" type="button" role="tab" aria-controls="speech-history" aria-selected="false">
            <i class="fas fa-microphone"></i> Speech Transcriptions
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="historyTabContent">
    
    <!-- Sign Detection History Tab -->
    <div class="tab-pane fade show active" id="sign-history" role="tabpanel" aria-labelledby="sign-tab">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="fas fa-hand-paper"></i> Sign Language Detection History</h5>
                {% if sign_history %}
                <button class="btn btn-danger btn-sm" onclick="showClearAllModal('sign')">
                    <i class="fas fa-trash-alt"></i> Clear All
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if sign_history %}
                    <p class="text-muted mb-3">Total signs detected: <strong>{{ sign_history|length }}</strong></p>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Sign Detected</th>
                                    <th>Confidence</th>
                                    <th>Timestamp</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detection in sign_history %}
                                    <tr>
                                        <td><strong>{{ detection.sign }}</strong></td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ detection.confidence * 100 }}%" aria-valuenow="{{ detection.confidence * 100 }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ "%.1f"|format(detection.confidence * 100) }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ detection.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger delete-btn" onclick="showDeleteModal({{ detection.id }}, 'sign_detection')" title="Delete this detection">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i> No sign language detections yet. Start using the sign detector to build your history!
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Speech Transcription History Tab -->
    <div class="tab-pane fade" id="speech-history" role="tabpanel" aria-labelledby="speech-tab">
        <div class="card">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="fas fa-microphone"></i> Speech-to-Text History</h5>
                {% if speech_history %}
                <button class="btn btn-danger btn-sm" onclick="showClearAllModal('speech')">
                    <i class="fas fa-trash-alt"></i> Clear All
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if speech_history %}
                    <p class="text-muted mb-3">Total transcriptions: <strong>{{ speech_history|length }}</strong></p>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Transcribed Text</th>
                                    <th>Confidence</th>
                                    <th>Timestamp</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transcription in speech_history %}
                                    <tr>
                                        <td><strong>{{ transcription.sign }}</strong></td>
                                        <td>
                                            <span class="badge bg-success">100%</span>
                                        </td>
                                        <td>{{ transcription.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger delete-btn" onclick="showDeleteModal({{ transcription.id }}, 'speech_to_text')" title="Delete this transcription">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i> No speech transcriptions yet. Start using the speech-to-text feature to build your history!
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div class="modal-header" style="border: none; padding: 2rem 2rem 1rem;">
                <h5 class="modal-title" style="color: var(--text-color); font-weight: 700;">
                    <i class="fas fa-exclamation-triangle" style="color: #e74c3c; margin-right: 0.5rem;"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 1rem 2rem 2rem; color: var(--text-color);">
                <p id="deleteMessage" style="font-size: 1.1rem; margin-bottom: 0;">Are you sure you want to delete this item?</p>
            </div>
            <div class="modal-footer" style="border: none; padding: 0 2rem 2rem; gap: 0.75rem;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 12px; padding: 0.75rem 1.5rem; font-weight: 600;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" style="border-radius: 12px; padding: 0.75rem 1.5rem; font-weight: 600; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clear All Confirmation Modal -->
<div class="modal fade" id="clearAllModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
            <div class="modal-header" style="border: none; padding: 2rem 2rem 1rem;">
                <h5 class="modal-title" style="color: var(--text-color); font-weight: 700;">
                    <i class="fas fa-exclamation-circle" style="color: #e74c3c; margin-right: 0.5rem;"></i>
                    Clear All History
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 1rem 2rem 2rem; color: var(--text-color);">
                <p id="clearAllMessage" style="font-size: 1.1rem; margin-bottom: 0;">Are you sure you want to delete all items? This action cannot be undone.</p>
            </div>
            <div class="modal-footer" style="border: none; padding: 0 2rem 2rem; gap: 0.75rem;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 12px; padding: 0.75rem 1.5rem; font-weight: 600;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmClearAllBtn" style="border-radius: 12px; padding: 0.75rem 1.5rem; font-weight: 600; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);">
                    <i class="fas fa-trash-alt"></i> Clear All
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentDeleteId = null;
let currentDeleteType = null;
let currentClearType = null;

function showDeleteModal(id, type) {
    currentDeleteId = id;
    currentDeleteType = type;
    const typeLabel = type === 'sign_detection' ? 'sign detection' : 'transcription';
    document.getElementById('deleteMessage').textContent = `Are you sure you want to delete this ${typeLabel}?`;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function showClearAllModal(type) {
    currentClearType = type;
    const typeLabel = type === 'sign' ? 'sign detections' : 'speech transcriptions';
    document.getElementById('clearAllMessage').textContent = `Are you sure you want to delete all ${typeLabel}? This action cannot be undone.`;
    const modal = new bootstrap.Modal(document.getElementById('clearAllModal'));
    modal.show();
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (currentDeleteId && currentDeleteType) {
            fetch(`/delete_detection/${currentDeleteId}`, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => {
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    location.reload();
                } else {
                    alert('Failed to delete the item. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the item.');
            });
        }
    });

    document.getElementById('confirmClearAllBtn').addEventListener('click', function() {
        if (currentClearType) {
            const detectionType = currentClearType === 'sign' ? 'sign_detection' : 'speech_to_text';
            fetch(`/clear_all_history/${detectionType}`, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => {
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('clearAllModal')).hide();
                    location.reload();
                } else {
                    alert('Failed to clear history. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while clearing history.');
            });
        }
    });
});
</script>

{% endblock %}
